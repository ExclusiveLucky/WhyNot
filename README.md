# Пример сервиса на FastAPI с блокировкой

Этот проект демонстрирует простой сервис на FastAPI с маршрутом `/test`, который выполняет задачу (`work`) последовательно, гарантируя, что несколько задач не выполняются одновременно, используя `asyncio.Lock`. Цель проекта — показать, как можно управлять параллелизмом в асинхронных приложениях на FastAPI.

## Особенности

- **Контроль параллелизма**: Гарантирует, что задачи выполняются последовательно с использованием `asyncio.Lock`.
- **FastAPI**: Предоставляет RESTful API с простой структурой для лёгкой интеграции.
- **Покрытие тестами**: Включает тесты для проверки функциональности сервиса.
- **Модульный дизайн**: Логика работы вынесена в сервис (`WorkService`), что делает код более расширяемым и поддерживаемым.

## Требования

- Python 3.11 или новее
- FastAPI
- Uvicorn (для запуска приложения FastAPI)
- Pytest (для тестирования)

## Установка

### Клонирование репозитория

```bash
git clone https://github.com/yourusername/fastapi-lock-service.git
cd fastapi-lock-service
```

### Создание виртуального окружения

```bash
python -m venv venv
source venv/bin/activate  # На Windows: venv\Scriptsctivate
```

### Установка зависимостей

```bash
pip install -r requirements.txt
```

`requirements.txt` должен содержать:

```
fastapi
uvicorn
pytest
httpx
```

## Запуск приложения

Для локального запуска приложения FastAPI используйте Uvicorn:

```bash
uvicorn main:app --reload
```

Приложение будет доступно по адресу `http://127.0.0.1:8000/test`.

## API Endpoint

### `GET /test`

Этот эндпоинт симулирует выполнение задачи (`work`), которая занимает 3 секунды. Задача выполняется последовательно, что означает, что только одна задача может быть запущена в каждый момент времени, гарантируя контроль параллелизма через `asyncio.Lock`.

#### Пример ответа

```json
{
  "elapsed": 3.002
}
```

## Запуск тестов

Для запуска тестов приложения используйте `pytest`:

```bash
pytest
```

Тесты находятся в директории `tests/` и используют `httpx` для тестирования эндпоинтов FastAPI.

### Пример файла с тестами

Ниже приведён пример простого теста, который проверяет, что эндпоинт `/test` работает корректно:

```python
import httpx
import pytest
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

@pytest.mark.asyncio
async def test_sequential_requests():
    async with httpx.AsyncClient() as async_client:
        response1 = await async_client.get('http://127.0.0.1:8000/test')
        assert response1.status_code == 200
        data1 = response1.json()
        assert data1["elapsed"] >= 3.0

        response2 = await async_client.get('http://127.0.0.1:8000/test')
        assert response2.status_code == 200
        data2 = response2.json()
        assert data2["elapsed"] >= 6.0  # Общее время должно быть не менее 6 секунд после двух последовательных запросов.
```

## Структура проекта

```
fastapi-lock-service/
├── main.py              # Основной код приложения
├── tests/
│   └── test_main.py     # Тесты для сервиса
├── requirements.txt     # Зависимости
└── README.md            # Документация проекта
```

- **`main.py`**: Содержит сервис FastAPI и логику `WorkService`.
- **`tests/`**: Директория с тестами для API.
- **`requirements.txt`**: Список зависимостей для проекта.
- **`README.md`**: Этот файл с документацией.

## Как это работает

- **Контроль параллелизма**: `asyncio.Lock()` гарантирует, что одновременно может выполняться только одна задача (`work`). Если на эндпоинт `/test` поступают несколько запросов, они будут обработаны последовательно с минимальным интервалом в 3 секунды между запросами.
- **Модульный дизайн**: Логика работы вынесена в класс `WorkService`, что обеспечивает разделение бизнес-логики и маршрутов API.
- **Тестируемость**: Проект структурирован таким образом, что тестирование логики API и контроля параллелизма упрощено с помощью `pytest` и `httpx`.

## Возможные улучшения

- **Динамическая продолжительность**: Сервис можно расширить, добавив возможность передавать время выполнения задачи через параметры запроса или тело запроса.
- **Детализированное логирование**: Добавить логирование для мониторинга начала, окончания задач и времени их выполнения.
- **Проверки состояния**: Реализовать эндпоинты для проверки состояния сервиса и мониторинга его работоспособности.

## Лицензия

Этот проект лицензирован по лицензии MIT. См. файл [LICENSE](LICENSE) для получения подробной информации.
